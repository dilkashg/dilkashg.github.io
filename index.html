<html>
<head>
<title>Cowin Vaccine Slots</title>
</head>
<audio id="alarm" src="alarms.mp3" muted></audio>
<p style="color: #000099;"><small><b>District</b> - North 24 pgs <b>Date</b> - 27th May to 2nd June</small></p>
<button id="startbutton" style="color: green;" onclick="clicked()">Start scan<br/></button>

<p id="45">Slots for min age 45 : </p>
<pre id="results45"></pre>
<p id="18">Slots for min age 18 : </p>
<pre id="results18"></pre>
<pre><i><b>
  <span style="color: green;">Green buttons</span> -> for dose 1 & 
  <span style="color: red;">Red buttons</span> -> for dose 2
</b></i></pre>
<br>
<span><i><small>*Auto-refresh every 5 seconds</small></i></span><br>
<span><i><small>**Alarm will be triggered for available slots for - min age 18 & min age 45 - Dose 1</small></i></span>

  <script type="text/javascript">

    var intervalId = '';

    function clicked() {
      var startButtonElement = document.getElementById("startbutton");
       if(startButtonElement.style.color == "green") {
        console.log("Starting scan ...");
        startButtonElement.innerHTML = "Stop scan";
        startButtonElement.style.color = "red";
       }
       else {
        console.log("Stopping scan ...");
        clearInterval(intervalId);
        startButtonElement.innerHTML = "Start scan";
        startButtonElement.style.color = "Green";
        return;
       } 

       intervalId = setInterval(function(){
         const Http = new XMLHttpRequest();
         const url='https://cdn-api.co-vin.in/api/v2/appointment/sessions/calendarByDistrict?district_id=730&date=27-05-2021';
		    //  const url='https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByPin?pincode=743126&date=21-05-2021';
         Http.open("GET", url);
         Http.send();

         Http.onreadystatechange = (e) => {
           //console.log(Http.responseText);
           parseData(Http.responseText);
         }
        }, 5000);
     }

     function parseData(data) {
      //  cleaning
      var minAge45Element = document.getElementById("45");
      var minAge18Element = document.getElementById("18");
      minAge45Element.innerHTML='Slots for min age 45 : ';
      minAge18Element.innerHTML='Slots for min age 18 : ';

      var jsonData;
      try {
        jsonData = JSON.parse(data);
      } catch (err) {
        minAge45Element.innerHTML = err.message;
        minAge18Element.innerHTML = err.message;
        return;
      }
       var currentdate = new Date(); 
            var datetime = "Last Sync: " + currentdate.getDate() + "/"
                    + (currentdate.getMonth()+1)  + "/" 
                    + currentdate.getFullYear() + " @ "  
                    + currentdate.getHours() + ":"  
                    + currentdate.getMinutes() + ":" 
                    + currentdate.getSeconds();
            console.log(datetime);
       for(var cen in jsonData.centers)
       {
         var center = jsonData.centers[cen];
         for(var sess in center.sessions) {
           if(center.sessions[sess].available_capacity != 0)
           {
            var session = center.sessions[sess];
            console.log('center name ---> ' + center.name + ' for AGE ' + session.min_age_limit);
            // console.log(session);

            if(session.min_age_limit == 45) {
              addButtons(center, session, 45);
            }
            else {
              addButtons(center, session, 18);
            }
           }
         }
       }
     }

     function addButtons(center, session, minAge) {
      var element = document.createElement("input");
      element.type="button";
      element.value = center.name;
      element.name = center.name;
      
      if(session.available_capacity_dose1 != 0) {
        playAudio();
        element.style="background-color:green; color:white";
      }
      else {
        element.style="background-color:red; color:white";
      }

      element.onclick = function() { 
        slotDetails(center, session, minAge);
      }
      
      if(minAge==45) {
        var minAge45Element = document.getElementById("45");
        minAge45Element.appendChild(element);
      }
      if(minAge==18) {
        var minAge18Element = document.getElementById("18");
        minAge18Element.appendChild(element);
      }
    }

    function slotDetails(center, session, minAge) {
      console.log("Details requested for center: " + center.name);
      var para2 ;
      if(minAge==45){
        para2 = document.getElementById("results45");
      }
      else{
        para2 = document.getElementById("results18");
      }
      
      para2.innerHTML = "Loading...";
      var resp = {
        "Center id" : center.center_id,
        "Center name" : center.name,
        "Address" : center.address,
        "State" : center.state_name,
        "District" : center.district_name,
        "Block name" : center.block_name,
        "Pincode" : center.pincode,
        "Lat" : center.lat,
        "Long" : center.long,
        "From" : center.from,
        "To" : center.to,
        "Fee type" : center.fee_type,
        "Session" : session
      }
      setTimeout(function(){ para2.innerHTML = JSON.stringify(resp, undefined, 2); }, 300);
    }

    function playAudio() {
      document.getElementById('alarm').play();
      document.getElementById('alarm').muted = false;
    }

  </script>
</html>
